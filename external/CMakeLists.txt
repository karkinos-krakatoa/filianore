# --------------------------------------------------------------------------------------------------
#  Compile Intel Embree (optional)
# --------------------------------------------------------------------------------------------------

if (FL_ENABLE_EMBREE)
  set_directory_properties(PROPERTIES COMPILE_OPTIONS "")

  set(EMBREE_ISPC_SUPPORT              OFF CACHE BOOL " " FORCE)
  set(EMBREE_TUTORIALS                 OFF CACHE BOOL " " FORCE)
  set(EMBREE_FILTER_FUNCTION           OFF CACHE BOOL " " FORCE)
  set(EMBREE_IGNORE_CMAKE_CXX_FLAGS    OFF CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_QUAD             OFF CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_CURVE            OFF CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_GRID             OFF CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_POINT            OFF CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_SUBDIVISION      OFF CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_INSTANCE         ON  CACHE BOOL " " FORCE)
  set(EMBREE_GEOMETRY_USER             ON  CACHE BOOL " " FORCE)
  set(EMBREE_IGNORE_INVALID_RAYS       ON  CACHE BOOL " " FORCE)
  set(EMBREE_RAY_MASK                  OFF CACHE BOOL " " FORCE)
  set(EMBREE_MAX_ISA "NONE"            CACHE STRING " " FORCE)
  set(EMBREE_STAT_COUNTERS             OFF CACHE BOOL " " FORCE)
  set(EMBREE_MAX_INSTANCE_LEVEL_COUNT  1 CACHE STRING " " FORCE)
  set(EMBREE_TASKING_SYSTEM            "INTERNAL" CACHE STRING " " FORCE)
  set(EMBREE_ISA_SSE2                  OFF CACHE BOOL " " FORCE)

  if (CMAKE_SYSTEM_PROCESSOR STREQUAL "arm64")
    set(EMBREE_ISA_SSE42            OFF CACHE BOOL " " FORCE)
    set(EMBREE_ISA_AVX              OFF CACHE BOOL " " FORCE)
    set(EMBREE_ISA_AVX2             OFF CACHE BOOL " " FORCE)
    set(EMBREE_ISA_AVX512           OFF CACHE BOOL " " FORCE)
    set(EMBREE_ISA_NEON             ON CACHE BOOL " " FORCE)
    set(EMBREE_ISA_NEON2X           ON CACHE BOOL " " FORCE)
  else()
    set(EMBREE_ISA_SSE42            ON CACHE BOOL " " FORCE)
    set(EMBREE_ISA_AVX              ON CACHE BOOL " " FORCE)
    set(EMBREE_ISA_AVX2             ON CACHE BOOL " " FORCE)
    if (MSVC)
        set(EMBREE_ISA_AVX512SKX    OFF CACHE BOOL " " FORCE)
    else()
        set(EMBREE_ISA_AVX512SKX    ON CACHE BOOL " " FORCE)
    endif()
    set(EMBREE_ISA_NEON             OFF CACHE BOOL " " FORCE)
    set(EMBREE_ISA_NEON2X           OFF CACHE BOOL " " FORCE)
  endif()

  if (CMAKE_CXX_COMPILER_ID MATCHES "Clang" OR CMAKE_CXX_COMPILER_ID MATCHES "GNU")
    add_compile_options(-Wno-unused-variable)
  endif()

  # Briefly remove -march=native and let Embree do it's own ISA selection
  unset(CMAKE_CXX_VISIBILITY_PRESET)
  add_subdirectory(embree)
  set(CMAKE_CXX_VISIBILITY_PRESET "hidden")
  set(EMBREE_INCLUDE_DIRS "${CMAKE_CURRENT_SOURCE_DIR}/embree/include" PARENT_SCOPE)

  if (MSVC)
    # Don't complain about ignored alignment specifier
    target_compile_options(embree PRIVATE "/wd4359")
  endif()

  set_property(TARGET
    lexers math simd sys tasking embree ${EMBREE_TARGET}
    PROPERTY FOLDER "dependencies/embree")
endif()

mark_as_advanced(FORCE EMBREE_ADDRESS_SANITIZER EMBREE_API_NAMESPACE
  EMBREE_BACKFACE_CULLING EMBREE_COMPACT_POLYS
  EMBREE_CURVE_SELF_INTERSECTION_AVOIDANCE_FACTOR EMBREE_FILTER_FUNCTION
  EMBREE_GEOMETRY_CURVE EMBREE_GEOMETRY_GRID EMBREE_GEOMETRY_INSTANCE
  EMBREE_GEOMETRY_POINT EMBREE_GEOMETRY_QUAD EMBREE_GEOMETRY_SUBDIVISION
  EMBREE_GEOMETRY_TRIANGLE EMBREE_GEOMETRY_USER EMBREE_IGNORE_CMAKE_CXX_FLAGS
  EMBREE_IGNORE_INVALID_RAYS EMBREE_ISA_AVX EMBREE_ISA_AVX2 EMBREE_ISA_AVX512
  EMBREE_ISA_AVX512SKX EMBREE_ISA_NEON EMBREE_ISA_NEON2X EMBREE_ISA_SSE2
  EMBREE_ISA_SSE42 EMBREE_ISPC_SUPPORT EMBREE_LIBRARY_NAME
  EMBREE_MAX_INSTANCE_LEVEL_COUNT EMBREE_MAX_ISA EMBREE_MIN_WIDTH
  EMBREE_RAY_MASK EMBREE_RAY_PACKETS EMBREE_STACK_PROTECTOR EMBREE_STATIC_LIB
  EMBREE_STAT_COUNTERS EMBREE_TASKING_SYSTEM EMBREE_TBB_COMPONENT
  EMBREE_TESTING_BENCHMARK EMBREE_TESTING_BENCHMARK_DATABASE
  EMBREE_TESTING_INTENSITY EMBREE_TESTING_KLOCWORK EMBREE_TESTING_MEMCHECK
  EMBREE_TESTING_MODEL_DIR EMBREE_TESTING_PACKAGE EMBREE_TESTING_SDE
  EMBREE_TUTORIALS EMBRE_STATIC_LIB EMBREE_STATIC_RUNTIME)